# Layout & Routing Patterns

## ğŸ—‚ï¸ Route Groups Architecture

The project uses **Next.js Route Groups** to achieve clean layout separation. This architecture is documented comprehensively in [CODEBASE_ANALYSIS.md](mdc:CODEBASE_ANALYSIS.md) and [LAYOUT_STRATEGY.md](mdc:LAYOUT_STRATEGY.md).

### Route Groups Structure

```
src/app/
â”œâ”€â”€ layout.tsx           # Root layout (minimal)
â”œâ”€â”€ loading.tsx          # Global loading with skeleton
â”œâ”€â”€ (public)/            # Public pages group
â”‚   â”œâ”€â”€ layout.tsx       # Header + Footer layout
â”‚   â”œâ”€â”€ page.tsx         # Homepage
â”‚   â”œâ”€â”€ about/           # About pages
â”‚   â”œâ”€â”€ cars/            # Car browsing
â”‚   â”œâ”€â”€ profile/         # User profiles
â”‚   â””â”€â”€ favorites/       # Favorites page
â”œâ”€â”€ (auth)/              # Authentication group
â”‚   â”œâ”€â”€ layout.tsx       # Clean auth layout
â”‚   â”œâ”€â”€ login/           # Login pages
â”‚   â”œâ”€â”€ signup/          # Registration
â”‚   â”œâ”€â”€ forgot-password/ # Password reset
â”‚   â””â”€â”€ verify-email/    # Email verification
â””â”€â”€ dashboard/           # Dashboard (no group)
    â”œâ”€â”€ layout.tsx       # Sidebar layout
    â”œâ”€â”€ listings/        # Listing management
    â”œâ”€â”€ overview/        # Dashboard overview
    â””â”€â”€ settings/        # User settings
```

### Layout Inheritance Rules

**âœ… Correct Layout Assignment:**
- `/` â†’ `(public)/layout.tsx` â†’ Gets main header + footer
- `/cars/123` â†’ `(public)/layout.tsx` â†’ Gets main header + footer
- `/profile` â†’ `(public)/layout.tsx` â†’ Gets main header + footer
- `/login` â†’ `(auth)/layout.tsx` â†’ Gets minimal auth layout
- `/signup` â†’ `(auth)/layout.tsx` â†’ Gets minimal auth layout
- `/dashboard/*` â†’ `dashboard/layout.tsx` â†’ Gets sidebar + inline header

## ğŸ¯ Layout Component Patterns

### Root Layout (Minimal)
```typescript
// src/app/layout.tsx
export default function RootLayout({ children }: LayoutProps) {
  return (
    <html lang="ar" dir="rtl" suppressHydrationWarning>
      <body className="font-tajawal">
        <Providers>
          {children} {/* Only providers and children */}
          <Toaster />
          <StagewiseDevToolbar />
        </Providers>
      </body>
    </html>
  );
}
```

### Public Layout (Header + Footer)
```typescript
// src/app/(public)/layout.tsx
import Header from "@/components/layout/header/main";
import { Footer } from "@/components/layout/footer";
import { getUserWithProfile } from "@/app/actions";

export default async function PublicLayout({ children }: LayoutProps) {
  const user = await getUserWithProfile(); // Single optimized call
  
  return (
    <>
      <Header user={user} />
      {children}
      <Footer />
    </>
  );
}
```

### Auth Layout (Minimal)
```typescript
// src/app/(auth)/layout.tsx
export default function AuthLayout({ children }: LayoutProps) {
  return (
    <div className="min-h-screen flex items-center justify-center bg-background">
      <div className="w-full max-w-md">
        {children}
      </div>
    </div>
  );
}
```

### Dashboard Layout (Sidebar)
```typescript
// src/app/dashboard/layout.tsx
import AppSidebar from "@/components/layout/app-sidebar";
import { SidebarProvider, SidebarInset } from "@/components/ui/sidebar";
import { UserMenu } from "@/components/layout/header/UserMenu";
import { getUserWithProfile } from "@/app/actions";

export default async function DashboardLayout({ children }: LayoutProps) {
  const user = await getUserWithProfile();
  if (user?.role !== "seller") redirect("/");
  
  return (
    <SidebarProvider>
      <AppSidebar userInitial={user} />
      <SidebarInset>
        {/* Inline header with UserMenu */}
        <header className="flex h-16 shrink-0 items-center gap-2 border-b px-4">
          <SidebarTrigger className="-ml-1" />
          <Separator orientation="vertical" className="mr-2 h-4" />
          <div className="flex flex-1 items-center justify-between">
            <h1 className="font-semibold">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
            <div className="flex items-center gap-4">
              <ModeToggle />
              <UserMenu user={user} />
            </div>
          </div>
        </header>
        {children}
      </SidebarInset>
    </SidebarProvider>
  );
}
```

## ğŸ”„ User Data Fetching Strategy

### Optimized User Data Pattern
```typescript
// âœ… Single optimized server action
export async function getUserWithProfile(): Promise<DatabaseUser | null> {
  try {
    const {
      data: { user },
    } = await supabase.auth.getUser();

    if (!user) return null;

    const { data: userProfile } = await supabase
      .from("users")
      .select("*")
      .eq("id", user.id)
      .single();

    return userProfile || null;
  } catch (error) {
    console.error("Error fetching user with profile:", error);
    return null;
  }
}

// âœ… Usage in layouts
const user = await getUserWithProfile(); // Single call, complete data
```

### âŒ Avoid Multiple Calls Pattern
```typescript
// âŒ Don't do this - multiple server calls
const user = await getUser();
const userDetails = await getUserProfile(user?.id);

// âœ… Do this instead - single optimized call
const user = await getUserWithProfile();
```

## ğŸ¨ Header Component Strategy

### Modular Header System
```typescript
// âœ… Main header component
// src/components/layout/header/main.tsx
interface HeaderProps {
  user: DatabaseUser | null;
}

export default function Header({ user }: HeaderProps) {
  return (
    <header className="sticky top-0 z-50 w-full border-b bg-background/95 backdrop-blur">
      <div className="container flex h-16 items-center justify-between">
        <Logo />
        <Navigation />
        <UserMenu user={user} />
      </div>
    </header>
  );
}

// âœ… User menu component
// src/components/layout/header/UserMenu.tsx
"use client";

interface UserMenuProps {
  user: DatabaseUser | null;
}

export function UserMenu({ user }: UserMenuProps) {
  if (!user) {
    return <LoginButtons />;
  }

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="ghost" size="sm" className="relative h-8 w-8 rounded-full">
          <UserAvatar user={user} />
        </Button>
      </DropdownMenuTrigger>
      <UserMenuDropdown user={user} />
    </DropdownMenu>
  );
}
```

## ğŸ”’ Route Protection Patterns

### Server-Side Protection
```typescript
// âœ… Dashboard route protection
export default async function DashboardLayout({ children }: LayoutProps) {
  const user = await getUserWithProfile();
  
  // Protect seller-only routes
  if (user?.role !== "seller") {
    redirect("/");
  }
  
  return (
    <SidebarProvider>
      {/* Layout content */}
    </SidebarProvider>
  );
}

// âœ… Admin route protection  
export default async function AdminPage() {
  const user = await getUserWithProfile();
  
  if (user?.role !== "admin") {
    notFound(); // 404 for non-admin users
  }
  
  return <AdminDashboard user={user} />;
}
```

### Client-Side Navigation
```typescript
// âœ… Conditional navigation items
export function Navigation() {
  return (
    <nav className="flex items-center gap-6">
      <Link href="/">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</Link>
      <Link href="/cars">Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</Link>
      <Link href="/about">Ø¹Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹</Link>
    </nav>
  );
}

// âœ… Role-based menu items
export function UserMenuItems({ user }: { user: DatabaseUser }) {
  return (
    <>
      <DropdownMenuItem asChild>
        <Link href="/profile">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</Link>
      </DropdownMenuItem>
      <DropdownMenuItem asChild>
        <Link href="/favorites">Ø§Ù„Ù…ÙØ¶Ù„Ø©</Link>
      </DropdownMenuItem>
      {user.role === "seller" && (
        <DropdownMenuItem asChild>
          <Link href="/dashboard">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</Link>
        </DropdownMenuItem>
      )}
    </>
  );
}
```

## ğŸ“± Responsive Layout Patterns

### Mobile-First Approach
```typescript
// âœ… Responsive header with mobile menu
export default function Header({ user }: HeaderProps) {
  return (
    <header className="sticky top-0 z-50 w-full border-b bg-background/95 backdrop-blur">
      <div className="container flex h-16 items-center justify-between">
        <div className="flex items-center gap-4">
          <Sheet>
            <SheetTrigger asChild className="lg:hidden">
              <Button variant="ghost" size="sm">
                <Menu className="h-5 w-5" />
              </Button>
            </SheetTrigger>
            <MobileNavigation user={user} />
          </Sheet>
          <Logo />
        </div>
        
        <nav className="hidden lg:flex items-center gap-6">
          <Navigation />
        </nav>
        
        <UserMenu user={user} />
      </div>
    </header>
  );
}
```

### Sidebar Responsive Design
```typescript
// âœ… Responsive sidebar with proper mobile handling
export default function DashboardLayout({ children }: LayoutProps) {
  const cookieStore = await cookies();
  const defaultOpen = cookieStore.get("sidebar:state")?.value === "true";
  
  return (
    <SidebarProvider defaultOpen={defaultOpen}>
      <AppSidebar userInitial={user} />
      <SidebarInset>
        <div className="flex flex-1 flex-col gap-4 p-4">
          {children}
        </div>
      </SidebarInset>
    </SidebarProvider>
  );
}
```

## ğŸ¯ Loading States Strategy

### Global Loading Component
```typescript
// src/app/loading.tsx - Comprehensive skeleton
export default function Loading() {
  return (
    <div className="min-h-screen">
      {/* Header skeleton */}
      <div className="sticky top-0 z-50 w-full border-b bg-background">
        <div className="container flex h-16 items-center justify-between">
          <Skeleton className="h-8 w-32" />
          <div className="hidden lg:flex items-center gap-6">
            <Skeleton className="h-4 w-16" />
            <Skeleton className="h-4 w-20" />
            <Skeleton className="h-4 w-24" />
          </div>
          <Skeleton className="h-8 w-8 rounded-full" />
        </div>
      </div>
      
      {/* Page content skeleton */}
      <main className="container py-8">
        <HeroSkeleton />
        <SearchBarSkeleton />
        <CarsGridSkeleton />
        <TestimonialsSkeleton />
      </main>
      
      {/* Footer skeleton */}
      <FooterSkeleton />
    </div>
  );
}
```

## ğŸš¨ Layout Anti-Patterns to Avoid

### âŒ Avoid These Patterns
```typescript
// âŒ Don't duplicate header/footer in each page
export default function HomePage() {
  return (
    <>
      <Header /> {/* Duplicate header */}
      <main>Homepage content</main>
      <Footer /> {/* Duplicate footer */}
    </>
  );
}

// âŒ Don't fetch user data in every component
export function SomeComponent() {
  const [user, setUser] = useState(null);
  useEffect(() => {
    fetchUserData().then(setUser); // Wasteful repeated calls
  }, []);
}

// âŒ Don't mix layout concerns in page components
export default function CarDetailPage() {
  return (
    <div className="min-h-screen flex flex-col">
      {/* Layout logic in page component */}
    </div>
  );
}
```

### âœ… Correct Patterns
```typescript
// âœ… Clean page components that focus on content
export default function HomePage() {
  const cars = await getLatestListings();
  return (
    <main>
      <HeroSection />
      <FeaturedCars cars={cars} />
      <TestimonialsSection />
    </main>
  );
}

// âœ… Layout-specific data fetching in layout components
export default async function PublicLayout({ children }: LayoutProps) {
  const user = await getUserWithProfile(); // Layout handles user data
  return (
    <>
      <Header user={user} />
      {children}
      <Footer />
    </>
  );
}
```

## ğŸ“š Layout References

- **Route Groups**: [Next.js Route Groups Documentation](https://nextjs.org/docs/app/building-your-application/routing/route-groups)
- **Layout Patterns**: [LAYOUT_STRATEGY.md](mdc:LAYOUT_STRATEGY.md) for implementation details
- **Architecture Overview**: [CODEBASE_ANALYSIS.md](mdc:CODEBASE_ANALYSIS.md) for complete context
- **Component Guidelines**: Reference other `.cursor/rules/` files for component-specific patterns

Remember: Route Groups `(public)`, `(auth)` affect layout inheritance but don't affect URL paths. This creates clean separation between different layout needs while maintaining simple URLs.
